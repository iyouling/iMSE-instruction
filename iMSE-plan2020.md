# 2020掌酷微服务架构组建计划
---
## 0 背景
* 腾讯微服务平台TSF：公测时间为2019年3月13日至2019年7月30日
* 阿里云微服务引擎MSE：于2020年1月1日开始正式商业化，根据实际使用资源量进行扣费，费用从50.16元/月/节点起不等。

## 1 算一笔账
TODO

## 2 关于微服务
### 2.1 微服务架构是什么？
#### 2.1.1 微+服务
* 小：微服务体积小，2 pizza团队。
* 独：能够独立的部署和运行。
* 轻：使用轻量级的通信机制和架构。
* 松：为服务之间是松耦合的。

![consul](https://imse-1255691551.cos.ap-shanghai.myqcloud.com/consul.png)

#### 2.1.2 掌酷微服务架构iMSE
1. 针对掌酷的业务模式而设计的分布式、跨平台的微服务架构，提供应用全生命周期管理、数据化运营、立体化监控和服务治理等功能。

![TSF](https://imse-1255691551.cos.ap-shanghai.myqcloud.com/TSF.png)
---
![TSF](https://imse-1255691551.cos.ap-shanghai.myqcloud.com/TSF-1.png)

2. 提供掌酷技术开发团队使用的，可扩展、高可用、可持续交付的技术标准化流程

### 2.2 为什么要组建微服务架构？
#### 2.2.1 掌酷技术/运维/业务现状
* 评分
  1. 技术：20分
  2. 架构：0分

* 特点
  1. 没有统一的技术选型、架构陈旧、安全性低
  2. 部门间业务独立、分散，缺乏协同管理
  3. 部门内不同业务相互独立，资源利用率低
  4. 业务管理混乱：应用、主体、公众号、小程序、微信号缺乏统一管理
  5. 缺乏高可用、可快速部署、维护和扩展的架构
  6. 无法应对突如其来的高并发场景
  
* 现象
  1. 目前大多后端业务都使用PHP语言开发，但是框架都很陈旧或庞杂，例如php停留在5.x版本，thinkphp还是3.X版本，微擎框架重且耦合性非常高，前端没有统一框架，h5和小程序几乎都采用原生开发，复用性低且不利于维护。
  2. 由于业务耦合，架构单一，应对高并发场景时极易崩溃，且难以排除故障，导致用户、流量流失，造成重大经济损失
  3. 缺乏统一解决方案，面对各部门不同业务时运维一筹莫展，导致各部门都倾向技术兼运维
  4. 公司资源管理混乱，注册账号时找不到合适主体，注册好的账号空缺没有使用，可重复利用资源浪费
  5. 可复用的服务例如推送（通知、短信、提现、域名监控）服务，几乎每做一个项目都要重做一次或复制一次，且无法重用异步队列服务，造成资源浪费
  
* 总结：业务可以很牛逼，但支撑一直很脆弱。我们还是小米加步枪，同行已经拿起了二向箔
  
#### 2.2.2 行业发展
* 技术演变
	+ 单体架构 → RPC架构 → SOA架构 → 微服务架构

* 单体架构问题
  1. 复杂性逐渐变高：比如有的项目有几十万行代码，各个模块之间区别比较模糊，逻辑比较混乱，代码越多复杂性越高，越难解决遇到的问题。
  2. 技术债务逐渐上升：公司的人员流动是再正常不过的事情，有的员工在离职之前，疏于代码质量的自我管束，导致留下来很多坑，由于单体项目代码量庞大的惊人，留下的坑很难被发觉，这就给新来的员工带来很大的烦恼，人员流动越大所留下的坑越多，也就是所谓的技术债务越来越多。
  3. 阻碍技术创新：比如以前的某个项目使用tp3.2写的，由于各个模块之间有着千丝万缕的联系，代码量大，逻辑不够清楚，如果现在想用tp5来重构这个项目将是非常困难的，付出的成本将非常大，所以更多的时候公司不得不硬着头皮继续使用老的单体架构，这就阻碍了技术的创新。
  4. 无法按需伸缩：比如说电影模块是CPU密集型的模块，而订单模块是IO密集型的模块，假如我们要提升订单模块的性能，比如加大内存、增加硬盘，但是由于所有的模块都在一个架构下，因此我们在扩展订单模块的性能时不得不考虑其它模块的因素，因为我们不能因为扩展某个模块的性能而损害其它模块的性能，从而无法按需进行伸缩。
  5. 系统高可用性差：因为所有的功能开发最后都部署到同一个框架里，运行在同一个进程之中，一旦某一功能涉及的代码或者资源有问题，那就会影响整个框架中部署的功能。

#### 2.2.3 利与弊
TODO

## 3 组建方案
### 3.1 核心架构
![iMSE](https://imse-1255691551.cos.ap-shanghai.myqcloud.com/2020-iMSE.jpg)

### 3.2 服务组建
1. 业务分析
2. 服务拆分
3. 服务开发
4. 服务治理

### 3.3 技术标准化
1. 为前后端人员的技术选型提供统一的标准，减少冲突，节省沟通成本，新人快速上手
2. 整合部门间重复性高，频繁调用的业务，提供一套可复用、高可用、高性能、高维护性、易扩展、弹性伸缩的解决方案，可以承载未来的亿级用户量
3. 接入系统的资源（应用、主体、公众号、小程序、微信号）将统一管理，方便查询，提升资源利用率，部门间、部门内易于协调
4. 统一api接口文档，可读性强，易调试
5. 业务低耦合，降低单点故障影响，快速排错
6. 统一的数据中台，数据加工和沉淀，利于业务可持续发展，数据化运营

## 4 年度计划
### 4.1 总体架构
* 计划用一年时间组建完成，到2021年春节前可承载十亿级PV/日
* [全年任务拆解](https://shimo.im/sheets/T3wh9QDVxrKjHV8R/MODOC/)

### 4.2 人才计划
> 为企业持续培养技术人才，提升企业核心竞争力，提升个人价值实现
* 定期开展技术培训，促进员工交流提高
* 为技术一对一制定技术路线，让技术有清晰的发展方向
* 阶段性检验，定期评估技术人员的技能水平

## 5 分阶段目标
1. 第一阶段
* 时间：2019.12.1 - 2019.12.22
* 目标：技术储备，架构设计，实验试错，骨架搭建

2. 第二阶段（当前阶段）
* 时间：2019.12.23 - 2020.2.16
* 目标：核心架构开发

3. 第三阶段
* 时间：2020.2 - 2020.4
* 目标：小范围业务接入，灰度测试，ab压测，高并发业务接入

4. 第四阶段
* 时间：2020.5 - 2020.8
* 目标：服务拆分，完善，联调测试，标准化接入

5. 第五阶段
* 时间：2020.9 - 2021.1
* 目标：全面接入，大数据分析，全面管控，持续交付

## 6 人员配置
1. 第一阶段
3人：架构师1人 + 运维1人 + 后端1人

2. 第二阶段
3人：架构师1人 + 运维1人 + 后端1人

3. 第三阶段
5人：架构师1人 + 运维1人 + 产品1人 + 前端1人 + 后端1人

4. 第四阶段
8-10人：架构师1人 + 运维1-2人 + 产品1-2人 + 前端≥2人 + 后端≥3人

5. 第五阶段
10-15人：架构师1人 + 运维2-3人 + 产品2-3人 + 前端≥3人 + 后端≥3人 + 数据分析2人

## 7 成本预算
1. 人工成本
* 6w-30w/月
* 通过培训，降低人工成本

2. 硬件成本
* 300-500元/月/台
* 通过微服务架构，显著降低硬件成本

3. 是否增加成本
* 短期：增加
* 长期：减少